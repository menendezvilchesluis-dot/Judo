<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Control ‚Äì Marcador Judo</title>
<style>
  :root{--bg:#0b1020;--panel:#121a33;--accent:#28d07d;--blue:#1b58ff;--white:#f2f5ff;--warn:#ffd34d;--danger:#ff4d4d}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#05070f 60%);color:#e7ebff;font-family:system-ui,Segoe UI,Roboto,Arial;display:grid;grid-template-columns:420px 1fr;gap:18px;padding:18px}
  .panel{background:var(--panel);border:1px solid #1e2a55;border-radius:18px;padding:16px;overflow:auto}
  h1{margin:0 0 8px;font-size:20px;color:#8aa0ff}
  h2{margin:18px 0 8px;font-size:14px;text-transform:uppercase;color:#b9c6ff;letter-spacing:1.2px}
  label{display:block;font-size:12px;color:#c7d3ff;margin:10px 0 4px}
  input,button,select{font-size:14px}
  input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a3a72;background:#0f1833;color:#e7ebff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 12px;border-radius:12px;border:1px solid #2a3a72;background:#0f1833;color:#e7ebff;cursor:pointer}
  .btn.full{width:100%}
  .section{border-top:1px dashed #233067;margin:16px -16px 0;padding:16px}
  .preview{border-radius:16px;border:1px solid #233067;overflow:hidden}
  .score{font-weight:900;font-size:40px;margin-left:10px}
  .pill{padding:3px 8px;border-radius:999px;border:1px solid #2a3a72}
  .kbd{font-family:ui-monospace,Menlo,Consolas;background:#0b1430;padding:2px 6px;border-radius:6px;border:1px solid #24326b}

  /* mini preview simple */
  .mini{background:#000;height:280px;display:flex;align-items:center;justify-content:center;color:#2dd07a;font-weight:900;font-size:64px}
</style>
</head>
<body>
  <aside class="panel">
    <h1>Marcador de Judo ‚Äî Control</h1>

    <h2>Datos</h2>
    <div class="row">
      <div><label>Azul ‚Äî Nombre</label><input id="blueName" value="TORO SOLER J."></div>
      <div><label>Blanco ‚Äî Nombre</label><input id="whiteName" value="MANUKYAN R."></div>
    </div>
    <div class="row">
      <div><label>Club / Provincia (Azul)</label><input id="blueClub" value="VAL"></div>
      <div><label>Club / Provincia (Blanco)</label><input id="whiteClub" value="NAV"></div>
    </div>
    <div class="row">
      <div><label>Peso</label><input id="weight" value="-66 kg"></div>
      <div><label>Ronda</label><input id="round" value="Round 1"></div>
    </div>

    <h2>Tiempo</h2>
    <div class="grid3">
      <div><label>Min</label><input type="number" id="minutes" value="3" min="0"></div>
      <div><label>Seg</label><input type="number" id="seconds" value="0" min="0" max="59"></div>
      <div><label>&nbsp;</label><button class="btn full" id="applyTime">Aplicar</button></div>
    </div>
    <div class="grid3" style="margin-top:8px">
      <button class="btn" id="startStop">‚èØÔ∏è Iniciar / Pausar</button>
      <button class="btn" id="add10">‚ûï 10s</button>
      <button class="btn" id="sub10">‚ûñ 10s</button>
    </div>

    <div class="section">
      <h2>Puntos y sanciones</h2>
      <div class="row">
        <div>
          <label>Azul</label>
          <div class="grid3">
            <button class="btn" data-side="blue" data-type="yuko">+ Yuko (1)</button>
            <button class="btn" data-side="blue" data-type="waza">+ Wazari (2)</button>
            <button class="btn" data-side="blue" data-type="ippon">+ Ippon (3)</button>
          </div>
          <div class="grid3" style="margin-top:6px">
            <button class="btn" data-side="blue" data-type="yuko-">‚àí Yuko</button>
            <button class="btn" data-side="blue" data-type="waza-">‚àí Wazari</button>
            <button class="btn" data-side="blue" data-type="ippon-">‚àí Ippon</button>
          </div>
          <div class="grid3" style="margin-top:6px">
            <button class="btn" data-side="blue" data-type="shido">+ Shido (S)</button>
            <button class="btn" data-side="blue" data-type="shido-">‚àí Shido</button>
            <button class="btn" data-side="blue" data-type="hansoku">Hansoku (H)</button>
          </div>
        </div>
        <div>
          <label>Blanco</label>
          <div class="grid3">
            <button class="btn" data-side="white" data-type="yuko">+ Yuko (8)</button>
            <button class="btn" data-side="white" data-type="waza">+ Wazari (9)</button>
            <button class="btn" data-side="white" data-type="ippon">+ Ippon (0)</button>
          </div>
          <div class="grid3" style="margin-top:6px">
            <button class="btn" data-side="white" data-type="yuko-">‚àí Yuko</button>
            <button class="btn" data-side="white" data-type="waza-">‚àí Wazari</button>
            <button class="btn" data-side="white" data-type="ippon-">‚àí Ippon</button>
          </div>
          <div class="grid3" style="margin-top:6px">
            <button class="btn" data-side="white" data-type="shido">+ Shido (Shift+S)</button>
            <button class="btn" data-side="white" data-type="shido-">‚àí Shido</button>
            <button class="btn" data-side="white" data-type="hansoku">Hansoku (Shift+H)</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div><label><input type="checkbox" id="ruleW2I" checked> 2 Wazari = Ippon</label></div>
        <div><label><input type="checkbox" id="ruleS3H" checked> 3 Shido = Hansoku</label></div>
      </div>
      <div class="row">
        <div><label><input type="checkbox" id="ruleOsaAuto" checked> Osaekomi autom√°tico (10s=W, 20s=IP)</label></div>
        <div><label><input type="checkbox" id="ruleGSFinish" checked> GS termina al 1er Wazari/Ippon</label></div>
      </div>

      <div class="grid3" style="margin-top:10px">
        <button class="btn" id="resetScores">üîÅ Reset Puntos</button>
        <button class="btn" id="resetAll">üßπ Reset Todo</button>
        <button class="btn" id="openDisplay">üñ•Ô∏è Abrir Pantalla</button>
      </div>

      <div style="margin-top:8px;font-size:12px;opacity:.8">
        Atajos: Espacio play/pausa ¬∑ B +10s ¬∑ N ‚àí10s ¬∑ 1/2/3 Azul ¬∑ 8/9/0 Blanco ¬∑ S/Shift+S Shido ¬∑ H/Shift+H Hansoku.
      </div>
    </div>

    <div class="section">
      <h2>Golden Score & Osaekomi</h2>
      <div class="row">
        <button class="btn" id="toggleGS">üèÅ Iniciar Golden Score</button>
        <div>
          <label>Osaekomi (para)</label>
          <select id="osaSide">
            <option value="blue">Azul</option>
            <option value="white">Blanco</option>
          </select>
          <div class="grid3" style="margin-top:6px">
            <button class="btn" data-osa="10">10</button>
            <button class="btn" data-osa="15">15</button>
            <button class="btn" data-osa="20">20</button>
          </div>
        </div>
      </div>
      <div class="mini" id="miniTimer">3:00</div>
    </div>
  </aside>

  <main id="right"></main>

<script>
(function(){
  // ===== Estado =====
  const state = {
    blue:{name:'TORO SOLER J.',club:'VAL',yuko:0,waza:0,ippon:0,shido:0,hansoku:false},
    white:{name:'MANUKYAN R.',club:'NAV',yuko:0,waza:0,ippon:0,shido:0,hansoku:false},
    weight:'-66 kg', round:'Round 1', secondsTotal:180, running:false, golden:false
  };
  let remaining = state.secondsTotal, timerId=null;

  // ===== Canal para sincronizar con display.html =====
  const ch = new BroadcastChannel('judo-scoreboard');
  function broadcast(){ ch.postMessage({state, remaining}); }

  // ===== Utils =====
  const $ = s => document.querySelector(s);
  const pad = n => String(n).padStart(2,'0');
  const fmt = s => Math.floor(s/60)+':'+pad(s%60);
  function beep(freq,ms){ try{ const ac=new (window.AudioContext||window.webkitAudioContext)(); const o=ac.createOscillator(), g=ac.createGain(); o.connect(g); g.connect(ac.destination); o.frequency.value=freq; o.start(); g.gain.setValueAtTime(0.25, ac.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+ms/1000); setTimeout(()=>{o.stop(); ac.close();}, ms+60);}catch(e){} }

  // ===== Reglas =====
  let ruleW2I=true, ruleS3H=true, ruleOsaAuto=true, ruleGSFinish=true;
  $('#ruleW2I').onchange = e=> ruleW2I = e.target.checked;
  $('#ruleS3H').onchange = e=> ruleS3H = e.target.checked;
  $('#ruleOsaAuto').onchange = e=> ruleOsaAuto = e.target.checked;
  $('#ruleGSFinish').onchange = e=> ruleGSFinish = e.target.checked;

  function applyRules(side){
    if(ruleW2I && state[side].waza>=2){ state[side].waza=0; state[side].ippon+=1; stop(); beep(760,300); }
    if(ruleS3H && state[side].shido>=3){ state[side].hansoku=true; stop(); beep(280,550); }
    if(ruleGSFinish && state.golden && (state[side].ippon>0 || state[side].waza>0)){ stop(); beep(760,300); }
    renderMini(); broadcast();
  }

  // ===== Tiempo =====
  function tick(){
    if(!state.running) return;
    if(!state.golden && remaining>0){
      remaining--; renderMini(); broadcast();
      if(remaining===0){ stop(); beep(480,350); beep(320,350); }
    }else if(state.golden){
      remaining++; renderMini(); broadcast();
    }
  }
  function start(){ if(state.running) return; state.running=true; timerId=setInterval(tick,1000); renderMini(); broadcast(); }
  function stop(){ state.running=false; if(timerId){clearInterval(timerId); timerId=null;} renderMini(); broadcast(); }

  // ===== UI tiempo =====
  $('#applyTime').onclick = ()=>{ const m=+$('#minutes').value||0, s=+$('#seconds').value||0; state.secondsTotal=m*60+s; remaining=state.secondsTotal; state.golden=false; stop(); };
  $('#startStop').onclick = ()=> state.running? stop(): start();
  $('#add10').onclick = ()=>{ if(!state.golden){ remaining=Math.min(3599,remaining+10); renderMini(); broadcast(); } };
  $('#sub10').onclick = ()=>{ if(!state.golden){ remaining=Math.max(0,remaining-10); renderMini(); broadcast(); } };
  function renderMini(){ $('#miniTimer').textContent = fmt(remaining); }

  // ===== Datos =====
  function bindInput(id,who,key){ const el=$(id); el.addEventListener('input',()=>{ state[who][key]=el.value; broadcast(); }); }
  bindInput('#blueName','blue','name'); bindInput('#blueClub','blue','club');
  bindInput('#whiteName','white','name'); bindInput('#whiteClub','white','club');
  $('#weight').addEventListener('input',e=>{ state.weight=e.target.value; broadcast(); });
  $('#round').addEventListener('input',e=>{ state.round=e.target.value; broadcast(); });

  // ===== Puntos =====
  function adjust(side, field, delta){ state[side][field]=Math.max(0,(state[side][field]||0)+delta); applyRules(side); }
  function setHansoku(side,val){ state[side].hansoku=!!val; if(val){ stop(); beep(280,550);} renderMini(); broadcast(); }

  document.querySelectorAll('[data-side]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const s=btn.dataset.side, t=btn.dataset.type;
      if(t==='yuko')adjust(s,'yuko',1); else if(t==='yuko-')adjust(s,'yuko',-1);
      else if(t==='waza')adjust(s,'waza',1); else if(t==='waza-')adjust(s,'waza',-1);
      else if(t==='ippon')adjust(s,'ippon',1), stop();
      else if(t==='ippon-')adjust(s,'ippon',-1);
      else if(t==='shido')adjust(s,'shido',1);
      else if(t==='shido-')adjust(s,'shido',-1);
      else if(t==='hansoku')setHansoku(s,!state[s].hansoku);
    });
  });

  // Reset
  $('#resetScores').onclick = ()=>{ ['blue','white'].forEach(s=>{ state[s].yuko=0; state[s].waza=0; state[s].ippon=0; state[s].shido=0; state[s].hansoku=false;}); renderMini(); broadcast(); };
  $('#resetAll').onclick = ()=>{ stop(); state.blue={name:'',club:'',yuko:0,waza:0,ippon:0,shido:0,hansoku:false}; state.white={name:'',club:'',yuko:0,waza:0,ippon:0,shido:0,hansoku:false}; state.weight=''; state.round=''; state.secondsTotal=180; remaining=state.secondsTotal; renderMini(); broadcast(); };

  // Golden Score
  $('#toggleGS').onclick = ()=>{
    state.golden = !state.golden;
    if(state.golden){ remaining=0; start(); $('#toggleGS').textContent='‚èπÔ∏è Salir Golden Score'; }
    else{ stop(); remaining=state.secondsTotal; renderMini(); $('#toggleGS').textContent='üèÅ Iniciar Golden Score'; }
    broadcast();
  };

  // Osaekomi
  let osaId=null, osaSec=0;
  function startOsa(goal){
    if(osaId) clearInterval(osaId);
    osaSec=0;
    const side = $('#osaSide').value; // blue/white
    osaId=setInterval(()=>{
      osaSec++;
      if(osaSec===10){ beep(920,160); if(ruleOsaAuto) adjust(side,'waza',1); }
      if(osaSec===20){ if(ruleOsaAuto){ adjust(side,'ippon',1); stop(); } beep(760,320); clearInterval(osaId); }
      if(osaSec>=goal){ beep(600,240); clearInterval(osaId); }
    },1000);
  }
  document.querySelectorAll('[data-osa]').forEach(b=> b.addEventListener('click', ()=> startOsa(parseInt(b.dataset.osa,10)) ));

  // Pantalla
  $('#openDisplay').onclick = ()=> window.open('display.html','JudoDisplay','width=1280,height=720');

  // Atajos
  window.addEventListener('keydown',(e)=>{
    if(e.code==='Space'){ e.preventDefault(); state.running? stop(): start(); }
    else if(e.key==='b'||e.key==='B'){ if(!state.golden){ remaining=Math.min(3599,remaining+10); renderMini(); broadcast(); } }
    else if(e.key==='n'||e.key==='N'){ if(!state.golden){ remaining=Math.max(0,remaining-10); renderMini(); broadcast(); } }
    else if(e.key==='1'){ adjust('blue','yuko',1); }
    else if(e.key==='2'){ adjust('blue','waza',1); }
    else if(e.key==='3'){ adjust('blue','ippon',1); stop(); }
    else if(e.key==='8'){ adjust('white','yuko',1); }
    else if(e.key==='9'){ adjust('white','waza',1); }
    else if(e.key==='0'){ adjust('white','ippon',1); stop(); }
    else if(e.key==='s' || e.key==='S'){ if(e.shiftKey) adjust('white','shido',1); else adjust('blue','shido',1); }
    else if(e.key==='h' || e.key==='H'){ if(e.shiftKey) setHansoku('white', !state.white.hansoku); else setHansoku('blue', !state.blue.hansoku); }
  });

  // Init
  (function init(){
    const m=Math.floor(state.secondsTotal/60), s=state.secondsTotal%60;
    $('#minutes').value=m; $('#seconds').value=s; renderMini(); broadcast();
  })();
})();
</script>
</body>
</html>
